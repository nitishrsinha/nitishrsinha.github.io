<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Config Loading Test v2</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test { padding: 10px; margin: 5px 0; border-left: 3px solid #4ec9b0; }
        .pass { border-color: #4ec9b0; color: #4ec9b0; }
        .fail { border-color: #f48771; color: #f48771; }
        .info { border-color: #3794ff; color: #3794ff; }
        pre { background: #2d2d2d; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Config Loading Test v2</h1>
    <p style="color: #888;">With enhanced error capture</p>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        const errors = [];
        const logs = [];

        // Capture all console output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            logs.push(['LOG', ...args]);
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            logs.push(['ERROR', ...args]);
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            logs.push(['WARN', ...args]);
            originalWarn.apply(console, args);
        };

        // Capture script errors
        window.addEventListener('error', function(e) {
            errors.push({
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error ? e.error.toString() : 'N/A'
            });
        }, true);

        function test(name, condition) {
            const div = document.createElement('div');
            div.className = 'test ' + (condition ? 'pass' : 'fail');
            div.textContent = (condition ? '✓' : '✗') + ' ' + name;
            results.appendChild(div);
        }

        function info(text) {
            const div = document.createElement('div');
            div.className = 'test info';
            div.textContent = 'ℹ ' + text;
            results.appendChild(div);
        }

        test('window object exists', typeof window !== 'undefined');
        test('Can set window properties', (window.TEST_PROPERTY = 'test') === 'test');

        info('About to load traffic-config.js...');
    </script>

    <!-- Load the config with inline error handling -->
    <script
        src="traffic-config.js"
        onerror="document.getElementById('script-error').style.display='block';"
    ></script>

    <div id="script-error" style="display:none; color: #f48771; padding: 15px; border: 2px solid #f48771; margin: 15px 0;">
        ⚠️ <strong>Script tag failed to load traffic-config.js</strong><br>
        This means the browser couldn't fetch the file.
    </div>

    <!-- Test after loading -->
    <script>
        // Wait a moment for any async loading
        setTimeout(function() {
            test('TRAFFIC_CONFIG exists on window', typeof window.TRAFFIC_CONFIG !== 'undefined');

            if (window.TRAFFIC_CONFIG) {
                test('TRAFFIC_CONFIG has TOMTOM_API_KEY', 'TOMTOM_API_KEY' in window.TRAFFIC_CONFIG);
                test('API key is set', window.TRAFFIC_CONFIG.TOMTOM_API_KEY !== 'YOUR_TOMTOM_API_KEY_HERE');

                const pre = document.createElement('pre');
                pre.style.cssText = 'background: #2d2d2d; padding: 15px; border-radius: 5px; margin-top: 20px; color: #4ec9b0;';
                pre.textContent = '✓ Config loaded successfully:\n' + JSON.stringify(window.TRAFFIC_CONFIG, null, 2);
                results.appendChild(pre);
            }

            // Display captured errors
            if (errors.length > 0) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #2d0000; border-left: 3px solid #f48771;';
                errorDiv.innerHTML = '<h3 style="color: #f48771; margin-top: 0;">JavaScript Errors Detected:</h3>';

                errors.forEach(err => {
                    const pre = document.createElement('pre');
                    pre.style.cssText = 'background: #1e1e1e; padding: 10px; margin: 5px 0; color: #f48771; font-size: 12px;';
                    pre.textContent = `File: ${err.filename}\nLine ${err.lineno}, Col ${err.colno}\n${err.message}\n${err.error}`;
                    errorDiv.appendChild(pre);
                });

                results.appendChild(errorDiv);
            }

            // Display console logs
            if (logs.length > 0) {
                const logDiv = document.createElement('div');
                logDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #002b36; border-left: 3px solid #3794ff;';
                logDiv.innerHTML = '<h3 style="color: #3794ff; margin-top: 0;">Console Output:</h3>';

                const pre = document.createElement('pre');
                pre.style.cssText = 'background: #1e1e1e; padding: 10px; color: #3794ff; font-size: 12px; max-height: 300px; overflow-y: auto;';
                pre.textContent = logs.map(log => `[${log[0]}] ${log.slice(1).join(' ')}`).join('\n');
                logDiv.appendChild(pre);

                results.appendChild(logDiv);
            }

            // Try to fetch the config file manually to see if it's accessible
            fetch('traffic-config.js')
                .then(response => {
                    info(`Fetch test: HTTP ${response.status} - ${response.ok ? 'OK' : 'Failed'}`);
                    return response.text();
                })
                .then(text => {
                    info(`File size: ${text.length} bytes`);

                    // Show first 200 chars
                    const preview = document.createElement('pre');
                    preview.style.cssText = 'background: #2d2d2d; padding: 10px; margin-top: 10px; font-size: 11px; color: #888;';
                    preview.textContent = 'File preview (first 200 chars):\n' + text.substring(0, 200) + '...';
                    results.appendChild(preview);
                })
                .catch(err => {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'test fail';
                    errorDiv.textContent = `✗ Fetch test failed: ${err.message}`;
                    results.appendChild(errorDiv);
                });

        }, 100);
    </script>
</body>
</html>
